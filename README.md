# XiaoAI Switch2 Wake Up

这是一个基于ESP32的智能开关项目，可以通过WiFi连接到巴法云(Bemfa Cloud)，实现远程控制LED灯的功能，并支持通过BLE广播唤醒小米AI音箱。

## 功能特点

- WiFi自动连接与配置门户
- 连接巴法云平台，实现远程控制
- 支持通过Web界面配置参数
- 集成BLE信标功能，可唤醒小米AI音箱
- 支持按钮短按进入配置模式，长按恢复出厂设置
- 状态LED指示灯显示设备运行状态
- 内置看门狗防止系统死机
- 参数持久化存储

## 硬件要求

- ESP32-C3开发板
- LED灯 (连接到GPIO13)
- 状态指示LED (连接到GPIO12)
- 触发按钮 (连接到GPIO9)
- USB转串口下载器（如果开发板没有集成）

## 软件依赖

- [WiFiManager](https://github.com/tzapu/WiFiManager) - 用于WiFi配置管理
- ESP32 Arduino core

## 安装与配置

### 1. 安装PlatformIO

确保已安装PlatformIO，可以通过VSCode插件安装。

### 2. 安装依赖库

项目会自动从platformio.ini安装所需依赖库。

### 3. 硬件连接

```
ESP32-C3    |  连接
------------|--------
GPIO12      |  状态LED正极 (负极接地)
GPIO13      |  控制LED正极 (负极接地)
GPIO9       |  按钮一端 (另一端接地)
3.3V        |  按钮上拉电阻 (可使用内部上拉)
```

### 4. 配置参数

首次使用或需要重新配置时，设备会创建一个名为"ESP32-ConfigAP"的热点，密码为"12345678"。连接该热点后，通过浏览器访问 `192.168.4.1` 进入配置页面。

需要配置的参数包括：
- Bafa User ID: 在巴法云平台获取的UID
- Bafa Topic: 创建的主题名称
- BLE Device MAC: 自定义BLE MAC地址
- BLE Adv Data: BLE广播数据

### 5. 按钮操作

- **短按** (小于3秒): 进入WiFi配置门户
- **长按** (大于3秒): 恢复出厂设置，清除所有配置

### 6. 状态指示

- **快速闪烁** (200ms): 配置模式
- **中速闪烁** (500ms): 正在连接WiFi
- **慢速闪烁** (2000ms): 已连接WiFi
- **常亮**: 错误状态

## 巴法云平台设置

1. 访问 [巴法云](https://www.bemfa.com/) 注册账号
2. 创建新主题，例如 "light001"
3. 获取用户UID
4. 在设备配置页面填入相应信息

## BLE唤醒功能

设备在接收到"on"指令时会启动BLE广播1秒钟，广播数据包含预定义的唤醒信息，可用于唤醒小米AI音箱。

## 编译与上传

使用PlatformIO编译并上传固件：

```bash
pio run -t upload
```

查看串口监视器：

```bash
pio device monitor
```

## 故障排除

1. 如果无法连接WiFi，尝试短按按钮重新配置
2. 如果无法连接巴法云，请检查UID和主题名称是否正确
3. 如果BLE功能不工作，检查MAC地址格式是否正确
4. 查看串口监视器输出获取详细调试信息

## 许可证

本项目基于MIT许可证开源。